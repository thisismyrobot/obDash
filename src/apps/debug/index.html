{% extends 'base.html' %}

{% block javascript %}

    <script type="text/javascript">

        $(document).ready(function(){

            /*
                Get the time data
            */

            // Read the time as an epoc
            $.get('/time', function(json) {
                // Render the device epoc
                $('#db_dev_epoch').text(json.dev_epoch);

                // Render the pretty device date
                var d = new Date(0);
                d.setUTCSeconds(json.dev_epoch);
                $('#db_date_pretty').text(d);

                // Render the offset
                var offset = json.data_offset;
                if (offset === null) {
                    $('#db_data_offset').append(
                        '<span>NOT SET</span>'
                    ).append(
                        $('<button>Set</button>').click(function() {
                            obdash.setTime();
                            obdash.refresh(250);
                        })
                    );
                }
                else {
                    $('#db_data_offset').text(offset);
                }

                // Render the data epoch
                $('#db_data_epoch').text(json.data_epoch);

                // Render the pretty data date
                if (json.data_epoch !== null) {
                    var d = new Date(0);
                    d.setUTCSeconds(json.data_epoch);
                    $('#db_data_pretty').text(d);
                }
            });

            /*
                Talk to the ELM327
            */

            // Register a set of listeners for replies
            obdash.on(0x01, 0x00, function(data) {
                $('#db_pid_support_1').text(data.value);
            });
            obdash.on(0x01, 0x20, function(data) {
                $('#db_pid_support_2').text(data.value);
            });
            obdash.on(0x01, 0x40, function(data) {
                $('#db_pid_support_3').text(data.value);
            });
            obdash.on(0x01, 0x60, function(data) {
                $('#db_pid_support_4').text(data.value);
            });

            // Now register some data to be informed of new values for
            obdash.start([
                [0x01, 0x00], // The list of PIDs supported in block 1
                [0x01, 0x20], // The list of PIDs supported in block 2
                [0x01, 0x40], // The list of PIDs supported in block 3
                [0x01, 0x60], // The list of PIDs supported in block 4
            ], 1); // Times/second to attempt to get all the data

        });
    </script>

{% endblock %}

{% block content %}

<h3>Debug</h3>
<h4>Time</h4>
<table border="1">
    <tr>
        <td>
            Device epoch
        </td>
        <td id="db_dev_epoch"></td>
    </tr>
    <tr>
        <td>
            Device date
        </td>
        <td id="db_date_pretty"></td>
    </tr>
    <tr>
        <td>
            Device data offset
        </td>
        <td id="db_data_offset"></td>
    </tr>
    <tr>
        <td>
            Data epoch
        </td>
        <td id="db_data_epoch"></td>
    </tr>
    <tr>
        <td>
            Data date
        </td>
        <td id="db_data_pretty"></td>
    </tr>
</table>

<h4>Supported PIDs</h4>
<table border="1">
    <tr>
        <td>
            Block 01
        </td>
        <td id="db_pid_support_1"></td>
    </tr>
    <tr>
        <td>
            Block 02
        </td>
        <td id="db_pid_support_2"></td>
    </tr>
    <tr>
        <td>
            Block 03
        </td>
        <td id="db_pid_support_3"></td>
    </tr>
    <tr>
        <td>
            Block 04
        </td>
        <td id="db_pid_support_4"></td>
    </tr>
</table>

{% endblock %}
